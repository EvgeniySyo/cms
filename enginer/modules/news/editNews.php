<?php$MonthS = array("Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь");echo CMS::AdminModuleSection(24, "", "");$list = $ListNews = '';if ($_GET['page'] == 8) {    $SelectC = Simple_DbApi::select_db($_GET['name_tamlates'] . "_cat", "*", "", "", "names", 1, "", "");    if (!empty($SelectC)) {        foreach ($SelectC as $i => $nc) {            $list .= CMS::AdminModuleSection(27, "{module},{name},{id}", $_GET['name_tamlates'] . "<><>" . $nc['names'] . "<><>" . $nc['ids']);        }        echo CMS::AdminModuleSection(26, "{listcat}", $list);    }    $SelectN = Simple_DbApi::query_db("SELECT * FROM `" . _PREFIXDB_ . $_GET['name_tamlates'] . "` WHERE `id_cat`='0' ORDER BY `date` DESC, `time` DESC LIMIT 0,$MaxNewsOnPage");    if (!empty($SelectN)) {        $CountNews = Simple_DbApi::CountTable($_GET['name_tamlates'], "id_cat", 0);        foreach ($SelectN as $t => $nn) {            list($YEARR, $MONTHR, $DAYR) = explode("-", $nn['date']);            $MONTH = $MonthS[($MONTHR - 1)];            $dateR = $DAYR . " " . $MONTH . " " . $YEARR . "г.";            $statusNew = $nn['status'] == 0 ? CMS::AdminModuleSection('5-3', '{id}', $nn['id']) : CMS::AdminModuleSection('5-4', '{id}', $nn['id']);            $ListNews .= CMS::AdminModuleSection(29, "{name},{data},{module},{id},{status}", $nn['name'] . "<><>" . $dateR . " " . $nn['time'] . "<><>" . $_GET['name_tamlates'] . "<><>" . $nn['id'] . "<><>" . $statusNew);        }        echo CMS::AdminModuleSection(28, "{list}", $ListNews);        if ($CountNews > $MaxNewsOnPage) {            $maxPage = intval(($CountNews - 1) / $MaxNewsOnPage) + 1;            $MaxGoBack = $maxPage - $MaxListNumber;            if ($pagen > ($maxPage - 1) || $pagen < 0) $pagen = 0;            if (($pagen + 1) <= $MaxListNumber) {                $start = 0;                if ($MaxListNumber > $maxPage) $end = $maxPage;                else $end = $MaxListNumber;            } else {                if ($pagen == ($maxPage - 1) || $pagen > $MaxGoBack) {                    $start = $maxPage - $MaxListNumber;                    $end = $maxPage;                } else {                    $start = $pagen - (round($MaxListNumber / 2));                    $end = $MaxListNumber + $start;                }            }            for ($p = $start; $p < $end; $p++) {                if ($pagen == $p) $ListPage .= CMS::AdminModuleSection('42-1', "{n}", ($p + 1));                else $ListPage .= CMS::AdminModuleSection(42, "{module},{page},{n}", $_GET['name_tamlates'] . "<><>" . $p . "<><>" . ($p + 1));            }            if ($pagen != 0) $backN = CMS::AdminModuleSection('42-2', "{module},{page}", $_GET['name_tamlates'] . "<><>" . ($pagen - 1));            if (($maxPage - 1) != $pagen) $nexN = CMS::AdminModuleSection('42-3', "{module},{page}", $_GET['name_tamlates'] . "<><>" . ($pagen + 1));            echo CMS::AdminModuleSection(41, "{list},{next},{back}", $ListPage . "<><>" . $nexN . "<><>" . $backN);        }    }}if ($_GET['page'] == 4) {    if (!isset($_GET['id_cat']) || !is_numeric($_GET['id_cat'])) {        $SelectC = Simple_DbApi::select_db($_GET['name_tamlates'] . "_cat", "*", "", "", "names", 1, "", "");        if (!empty($SelectC)) {            foreach ($SelectC as $i => $nc) {                $list .= CMS::AdminModuleSection(27, "{module},{name},{id}", $_GET['name_tamlates'] . "<><>" . $nc['names'] . "<><>" . $nc['ids']);            }            echo CMS::AdminModuleSection(26, "{listcat}", $list);        } else echo CMS::AdminModuleSection(30, "{module}", $_GET['name_tamlates']);    } else {        if (!isset($_GET['id_news']) || !is_numeric($_GET['id_news'])) $pagen = 0;        else $pagen = $_GET['id_news'];        $limit = abs($pagen * $MaxNewsOnPage);        $SelectC = Simple_DbApi::select_db($_GET['name_tamlates'] . "_cat", "*", "ids", $_GET['id_cat'], "", "", "", "");        if (!empty($SelectC)) {            $CountNews = Simple_DbApi::CountTable($_GET['name_tamlates'], "id_cat", $_GET['id_cat']);            if ($CountNews > 0) {                if (!isset($_GET['id_st']) || !is_numeric($_GET['id_st'])) {                    $SelectN = Simple_DbApi::query_db("SELECT * FROM `" . _PREFIXDB_ . $_GET['name_tamlates'] . "` WHERE `id_cat`='" . $_GET['id_cat'] . "' ORDER BY `date` DESC, `time` DESC LIMIT $limit,$MaxNewsOnPage");                    if (!empty($SelectN)) {                        foreach ($SelectN as $t => $nn) {                            list($YEARR, $MONTHR, $DAYR) = explode("-", $nn['date']);                            $MONTH = $MonthS[($MONTHR - 1)];                            $dateR = $DAYR . " " . $MONTH . " " . $YEARR . "г.";                            $statusNew = $nn['status'] == 0 ? CMS::AdminModuleSection('5-3', '{id}', $nn['id']) : CMS::AdminModuleSection('5-4', '{id}', $nn['id']);                            $ListNews .= CMS::AdminModuleSection(34, "{name},{data},{module},{id},{idnews},{page},{status},{id_new}", $nn['name'] . "<><>" . $dateR . " " . $nn['time'] . "<><>" . $_GET['name_tamlates'] . "<><>" . $_GET['id_cat'] . "<><>" . $nn['id'] . "<><>" . $pagen . "<><>" . $statusNew . "<><>" . $nn['id']);                        }                        $nt = current($SelectC);                        echo CMS::AdminModuleSection(33, "{list},{namecat}", $ListNews . "<><>" . $nt['names']);                    }                } else {                    if (isset($_POST['edit'])) {                        $NameNews = strip_tags($_POST['NameNews']);                        $FullNews = $_POST['FCKeditor'];                        $SearchText = strip_tags($FullNews);                        $IdCategory = $_POST['category'];                        if ($_POST['addcomment'] == 1) $commentsAdd = 1;                        else $commentsAdd = 0;                        if (!is_numeric($IdCategory) || $IdCategory < 1) $IdCategory = 0;                        $SmallText = trim(ModuleNews::SelectTextSmall($FullNews));                        if (!is_numeric($_POST['day']) || !is_numeric($_POST['month']) || !is_numeric($_POST['year']) || !is_numeric($_POST['hour']) || !is_numeric($_POST['minute']) || !is_numeric($_POST['second'])) echo CMS::AlertWindow('Ошибка', 'Не верный формат даты', 3, 0);                        else {                            if (strlen($NameNews) < 3) echo CMS::AlertWindow('Ошибка', 'Название новости должно быть более 3-х символов', 3, 0);                            else {                                if (empty($FullNews)) echo CMS::AlertWindow('Ошибка', 'Не указан текст новости', 3, 0);                                else {                                    if (!empty($_POST['enddate']) && $_POST['enddate'] && ($_POST['year'] > $_POST['yearend'] ||                                            ($_POST['month'] > $_POST['monthend'] && $_POST['year'] == $_POST['yearend']) ||                                            ($_POST['day'] > $_POST['dayend'] && $_POST['month'] == $_POST['monthend'] && $_POST['year'] == $_POST['yearend']) ||                                            ($_POST['day'] == $_POST['dayend'] && $_POST['month'] == $_POST['monthend'] && $_POST['year'] == $_POST['yearend'] &&                                                ($_POST['hour'] > $_POST['hourend'] || (($_POST['minute'] > $_POST['minuteend'] || ($_POST['second'] > $_POST['secondend'] && $_POST['minute'] == $_POST['minuteend'])) && $_POST['hour'] == $_POST['hourend'])))))                                        echo CMS::AlertWindow('Ошибка', 'Дата начала публикации больше даты окончания', 3, 0);                                    else {                                        $DateNews = dateFormat($_POST['year']) . '-' . (dateFormat($_POST['month']) + 1) . '-' . dateFormat($_POST['day']);                                        $TimeNews = dateFormat($_POST['hour']) . ':' . dateFormat($_POST['minute']) . ':' . dateFormat($_POST['second']);                                        $DateNewsEnd = $TimeNewsEnd = '';                                        if (!empty($_POST['enddate'])) {                                            $DateNewsEnd = dateFormat($_POST['yearend']) . '-' . (dateFormat($_POST['monthend']) + 1) . '-' . dateFormat($_POST['dayend']);                                            $TimeNewsEnd = dateFormat($_POST['hourend']) . ':' . dateFormat($_POST['minuteend']) . ':' . dateFormat($_POST['secondend']);                                        }                                        CMS::UpdateSearchText($_GET['id_st'], $SearchText, $NameNews, "/" . $_GET['name_tamlates'] . "/0/in/" . $IdCategory . "/0/" . $_GET['id_st'] . "/");                                        $clearImg = 0;                                        $file = $_FILES['file']['tmp_name'];                                        $file_name = $_FILES['file']['name'];                                        if (!empty($file_name) || !empty($_POST['image']) && $_POST['image'] == 'on') {                                            $SelectType = Simple_DbApi::select_db($_GET['name_tamlates'], 'id,type', 'id', $_GET['id_st'], '', '', 0, 1);                                            $ni = current($SelectType);                                            if (!empty($ni['type'])) {                                                if (file_exists('images/' . $_GET['name_tamlates'] . '/small/' . $ni['id'] . '.' . $ni['type'])) unlink('images/' . $_GET['name_tamlates'] . '/small/' . $ni['id'] . '.' . $ni['type']);                                                $clearImg = 1;                                            }                                        }                                        if (!empty($file_name)) {                                            $nameFile = $ni['id'] . "." . simple_imagetest_format($file_name, 2);                                            $path3 = "images/" . $_GET['name_tamlates'] . "/small/" . $nameFile;                                            move_uploaded_file($file, $path3);                                            simple_image_save($SmallImageWidth, $SmallImageHeight, $path3, $path3, simple_imagetest_format($file_name, 2), 1);                                            Simple_DbApi::update_db($_GET['name_tamlates'], "id_cat,name,search,small,full,comment,date,time,dateend,timeend,type", $IdCategory . "<><>" . $NameNews . "<><>" . $SearchText . "<><>" . $SmallText . "<><>" . $FullNews . "<><>" . $commentsAdd . "<><>" . $DateNews . "<><>" . $TimeNews . "<><>" . $DateNewsEnd . "<><>" . $TimeNewsEnd . '<><>' . simple_imagetest_format($file_name, 2), "id", $_GET['id_st']);                                        } else {                                            if ($clearImg == 1)                                                Simple_DbApi::update_db($_GET['name_tamlates'], "id_cat,name,search,small,full,comment,date,time,dateend,timeend,type", $IdCategory . "<><>" . $NameNews . "<><>" . $SearchText . "<><>" . $SmallText . "<><>" . $FullNews . "<><>" . $commentsAdd . "<><>" . $DateNews . "<><>" . $TimeNews . "<><>" . $DateNewsEnd . "<><>" . $TimeNewsEnd . "<><>" . '', "id", $_GET['id_st']);                                            else                                                Simple_DbApi::update_db($_GET['name_tamlates'], "id_cat,name,search,small,full,comment,date,time,dateend,timeend", $IdCategory . "<><>" . $NameNews . "<><>" . $SearchText . "<><>" . $SmallText . "<><>" . $FullNews . "<><>" . $commentsAdd . "<><>" . $DateNews . "<><>" . $TimeNews . "<><>" . $DateNewsEnd . "<><>" . $TimeNewsEnd, "id", $_GET['id_st']);                                        }                                        //	Simple_DbApi::update_db($_GET['name_tamlates'],"id_cat,name,search,small,full,comment,date,time,dateend,timeend",$IdCategory."<><>".$NameNews."<><>".$SearchText."<><>".$SmallText."<><>".$FullNews."<><>".$commentsAdd."<><>".$DateNews."<><>".$TimeNews."<><>".$DateNewsEnd."<><>".$TimeNewsEnd,"id",$_GET['id_st']);                                        CMS::UserEvents('<b>' . $_SESSION["login_admin"] . '</b> внес изменения в новость <b>' . $NameNews . '</b> в модуле <b>' . $TitleModule . '</b>. Раздел <a target="_blank" href="main-modules-setting-mod-' . $_GET['name_tamlates'] . '-' . $_GET['page'] . '-' . $_GET['id_cat'] . '-' . $_GET['id_news'] . '-' . $_GET['id_st'] . '.pl"><b>Редактировать новости</b></a>');                                        echo CMS::AlertWindow('Успешно', 'Данные обновлены', 1, 0);                                        # DESTROY #                                        unset($NameNews);                                        unset($FullNews);                                        unset($SearchText);                                        unset($IdCategory);                                        unset($commentsAdd);                                    }                                }                            }                        }                    }                    $SelectNews = Simple_DbApi::select_db($_GET['name_tamlates'], "*", "id", $_GET['id_st'], "", "", "", "");                    if (!empty($SelectNews)) {                        $ne = current($SelectNews);                        $com1 = "";                        $com2 = "";                        $day = $minute = $month = $second = $hour = $hourend = $img = '';                        if ($ne['comment'] == 1) $com1 = "selected";                        else $com2 = "selected";                        $FormComment = CMS::AdminModuleSection(22, "{com1},{com2}", $com1 . "<><>" . $com2);                        $ne['full'] = htmlspecialchars($ne['full']);                        $ne['full'] = html_entity_decode($ne['full']);                        $ne['full'] = str_replace("\\", "", $ne['full']);                        $editor = CMS::CKeditor($ne['full'], '', '');                        $SelectC = Simple_DbApi::select_db($_GET['name_tamlates'] . "_cat", "*", "", "", "names", 1, "", "");                        if (!$SelectC) {                            foreach ($SelectC as $i => $nc) {                                if ($ne['id_cat'] == $nc['ids']) $select = "selected";                                $list .= CMS::AdminModuleSection(19, "{ID},{NAME},{selected}", $nc['ids'] . "<><>" . $nc['names'] . "<><>" . $select);                                unset($select);                            }                        }                        list($y1, $m1, $d1) = explode('-', $ne['date'], 3);                        list($h1, $mm1, $s1) = explode(':', $ne['time'], 3);                        list($y2, $m2, $d2) = explode('-', $ne['dateend'], 3);                        list($h2, $mm2, $s2) = explode(':', $ne['timeend'], 3);                        # DATE #                        for ($d = 1; $d < 32; $d++) {                            if (round($d1) == $d) $day .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                            else $day .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                        }                        unset($d);                        for ($d = 0; $d < count($DateList); $d++) {                            if ((round($m1) - 1) == $d) $month .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>selected');                            else $month .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>');                        }                        unset($d);                        for ($d = 0; $d < 24; $d++) {                            if (round($h1) == $d) $hour .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                            else $hour .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                        }                        unset($d);                        for ($d = 0; $d < 60; $d++) {                            if (round($mm1) == $d) $minute .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                            else $minute .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                        }                        for ($d = 0; $d < 60; $d++) {                            if (round($s1) == $d) $second .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                            else $second .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                        }                        #DATE2#                        if (round($y2)) {                            for ($d = 1; $d < 32; $d++) {                                if (round($d2) == $d) $dayend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                                else $dayend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                            }                            for ($d = 0; $d < count($DateList); $d++) {                                if ((round($m2) - 1) == $d) $monthend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>selected');                                else $monthend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>');                            }                            for ($d = 0; $d < 24; $d++) {                                if (round($h2) == $d) $hourend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                                else $hourend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                            }                            for ($d = 0; $d < 60; $d++) {                                if (round($mm2) == $d) $minuteend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                                else $minuteend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                            }                            for ($d = 0; $d < 60; $d++) {                                if (round($s2) == $d) $secondend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                                else $secondend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                            }                            $checkdate2 = "checked";                            $visibledate2 = "block";                        } else {                            $dayend = $day;                            $monthend = $month;                            $hourend = $hour;                            $minuteend = $minute;                            $secondend = $second;                            $y2 = $y1;                            $checkdate2 = "";                            $visibledate2 = "none";                        }                        //картинка                        $image = '';                        if (!empty($ne['type'])) {                            if (file_exists('images/' . $_GET['name_tamlates'] . '/small/' . $ne['id'] . '.' . $ne['type'])) $image = '<img src="../images/' . $_GET['name_tamlates'] . '/small/' . $ne['id'] . '.' . $ne['type'] . '" height="70" alt="" />';                        }                        if (!empty($image)) $img = CMS::AdminModuleSection(40, '{image}', $image);                        //end картинка                        echo CMS::AdminModuleSection(39, "{form},{CATEGORY},{name},{comment},{module},{id},{page},{day},{month},{year},{hour},{minute},{second},{dayend},{monthend},{yearend},{hourend},{minuteend},{secondend},{check},{visible},{image}", $editor . "<><>" . $list . "<><>" . $ne['name'] . "<><>" . $FormComment . "<><>" . $_GET['name_tamlates'] . "<><>" . $_GET['id_cat'] . "<><>" . $_GET['id_news'] . "<><>" . $day . "<><>" . $month . "<><>" . $y1 . "<><>" . $hour . "<><>" . $minute . "<><>" . $second . "<><>" . $dayend . "<><>" . $monthend . "<><>" . $y2 . "<><>" . $hourend . "<><>" . $minuteend . "<><>" . $secondend . "<><>" . $checkdate2 . "<><>" . $visibledate2 . "<><>" . $img);                        ### COMENTS LIST ###                        if (!isset($_POST['pageC']) || !is_numeric($_POST['pageC'])) $PageCom = 0;                        else $PageCom = $_POST['pageC'];                        if (isset($_POST['IdCom'])) {                            Simple_DbApi::delete_db($_GET['name_tamlates'] . "_comment", "id", $_POST['IdCom']);                            Simple_DbApi::update_db($_GET['name_tamlates'], "countcomments", Simple_DbApi::CountTable($_GET['name_tamlates'] . "_comment", "IdNews", $_GET['id_st']), "id", $_GET['id_st']);                            echo CMS::AlertWindow('Успешно', 'Комментарий удален', 1, 0);                        }                        $limit = abs($PageCom * $MaxNewsOnPage);                        $countComm = Simple_DbApi::CountTable($_GET['name_tamlates'] . "_comment", "IdNews", $_GET['id_st']);                        $SelectCommnets = Simple_DbApi::select_db($_GET['name_tamlates'] . "_comment", "*", "IdNews", $_GET['id_st'], "id", 2, $limit, $MaxNewsOnPage);                        if (!empty($SelectCommnets)) {                            foreach ($SelectCommnets as $j => $nb) {                                $ListComs .= CMS::AdminModuleSection(58, "{name},{text},{ip},{id}", $nb['name'] . "<><>" . $nb['text'] . "<><>" . $nb['ip'] . "<><>" . $nb['id']);                            }                        }                        if ($countComm > 0) {                            echo CMS::AdminModuleSection(57, "{list}", $ListComs);                            if ($countComm > $MaxNewsOnPage) {                                $FullCommPage = intval(($countComm - 1) / $MaxNewsOnPage) + 1;                                $MaxGoBack = $FullCommPage - $MaxListNumber;                                if ($PageCom > ($FullCommPage - 1) || $PageCom < 0) $pageNews = 0;                                if (($PageCom + 1) <= $MaxListNumber) {                                    $start = 0;                                    if ($MaxListNumber > $FullCommPage) $end = $FullCommPage;                                    else $end = $MaxListNumber;                                } else {                                    if ($PageCom == ($FullCommPage - 1) || $PageCom > $MaxGoBack) {                                        $start = $FullCommPage - $MaxListNumber;                                        $end = $FullCommPage;                                    } else {                                        $start = $PageCom - (round($MaxListNumber / 2));                                        $end = $MaxListNumber + $start;                                    }                                }                                for ($r = $start; $r < $end; $r++) {                                    if ($r == $PageCom) $ListComnets .= CMS::AdminModuleSection(60, "{n}", ($r + 1));                                    else $ListComnets .= CMS::AdminModuleSection(59, "{n},{n1}", ($r + 1) . "<><>" . $r);                                }                            }                            if ($PageCom != 0) $backP = CMS::AdminModuleSection('60-2', "{n}", ($PageCom - 1));                            if (($FullCommPage - 1) != $PageCom) $nextP = CMS::AdminModuleSection('60-3', "{n}", ($PageCom + 1));                            echo CMS::AdminModuleSection('60-1', "{list},{back},{next}", $ListComnets . "<><>" . $backP . "<><>" . $nextP);                            echo CMS::AdminModuleSection(61, '', '');                        }                        //$SelectCom = Simple_DbApi::select_db($_GET['name_tamlates']."_comment ","*","","","","","","");                        ### END ###                    } else echo CMS::AdminModuleSection(38, "{module}", $_GET['name_tamlates']);                }            } else echo CMS::AdminModuleSection(32, "{module}", $_GET['name_tamlates']);            if ($CountNews > $MaxNewsOnPage) {                $ListPage = $backN = $nexN = '';                if (!isset($_GET['id_st']) || !is_numeric($_GET['id_st'])) {                    $maxPage = intval(($CountNews - 1) / $MaxNewsOnPage) + 1;                    $MaxGoBack = $maxPage - $MaxListNumber;                    if ($pagen > ($maxPage - 1) || $pagen < 0) $pagen = 0;                    if (($pagen + 1) <= $MaxListNumber) {                        $start = 0;                        if ($MaxListNumber > $maxPage) $end = $maxPage;                        else $end = $MaxListNumber;                    } else {                        if ($pagen == ($maxPage - 1) || $pagen > $MaxGoBack) {                            $start = $maxPage - $MaxListNumber;                            $end = $maxPage;                        } else {                            $start = $pagen - (round($MaxListNumber / 2));                            $end = $MaxListNumber + $start;                        }                    }                    for ($j = $start; $j < $end; $j++) {                        if ($pagen == $j) $ListPage .= CMS::AdminModuleSection(37, "{n}", ($j + 1));                        else $ListPage .= CMS::AdminModuleSection(36, "{module},{id},{page},{n}", $_GET['name_tamlates'] . "<><>" . $_GET['id_cat'] . "<><>" . $j . "<><>" . ($j + 1));                    }                    if ($pagen != 0) $backN = CMS::AdminModuleSection('36-2', "{module},{page},{id}", $_GET['name_tamlates'] . "<><>" . ($pagen - 1) . "<><>" . $_GET['id_cat']);                    if (($maxPage - 1) != $pagen) $nexN = CMS::AdminModuleSection('36-3', "{module},{page},{id}", $_GET['name_tamlates'] . "<><>" . ($pagen + 1) . "<><>" . $_GET['id_cat']);                    echo CMS::AdminModuleSection(35, "{list},{next},{back}", $ListPage . "<><>" . $nexN . "<><>" . $backN);                }            }        } else echo CMS::AdminModuleSection(31, "{module}", $_GET['name_tamlates']);    }}if ($_GET['page'] == 5) {    $CountNews = Simple_DbApi::CountTable($_GET['name_tamlates'], "id_cat", 0);    if ($CountNews > 0) {        if (!isset($_GET['id_news']) || !is_numeric($_GET['id_news'])) {            if (!isset($_GET['id_cat']) || !is_numeric($_GET['id_cat'])) $pagen = 0;            else $pagen = $_GET['id_cat'];            $limit = abs($pagen * $MaxNewsOnPage);            $SelectN = Simple_DbApi::query_db("SELECT * FROM `" . _PREFIXDB_ . $_GET['name_tamlates'] . "` WHERE `id_cat`='0' ORDER BY `date` DESC, `time` DESC LIMIT $limit,$MaxNewsOnPage");            if (!empty($SelectN)) {                foreach ($SelectN as $t => $nn) {                    list($YEARR, $MONTHR, $DAYR) = explode("-", $nn['date']);                    $MONTH = $MonthS[($MONTHR - 1)];                    $dateR = $DAYR . " " . $MONTH . " " . $YEARR . "г.";                    $ListNews .= CMS::AdminModuleSection(45, "{name},{data},{module},{page},{id}", $nn['name'] . "<><>" . $dateR . " " . $nn['time'] . "<><>" . $_GET['name_tamlates'] . "<><>" . $_GET['id_cat'] . "<><>" . $nn['id']);                }                echo CMS::AdminModuleSection(28, "{list}", $ListNews);                if ($CountNews > $MaxNewsOnPage) {                    $maxPage = intval(($CountNews - 1) / $MaxNewsOnPage) + 1;                    $MaxGoBack = $maxPage - $MaxListNumber;                    if ($pagen > ($maxPage - 1) || $pagen < 0) $pagen = 0;                    if (($pagen + 1) <= $MaxListNumber) {                        $start = 0;                        if ($MaxListNumber > $maxPage) $end = $maxPage;                        else $end = $MaxListNumber;                    } else {                        if ($pagen == ($maxPage - 1) || $pagen > $MaxGoBack) {                            $start = $maxPage - $MaxListNumber;                            $end = $maxPage;                        } else {                            $start = $pagen - (round($MaxListNumber / 2));                            $end = $MaxListNumber + $start;                        }                    }                    for ($p = $start; $p < $end; $p++) {                        if ($pagen == $p) $ListPage .= CMS::AdminModuleSection('42-1', "{n}", ($p + 1));                        else $ListPage .= CMS::AdminModuleSection(42, "{module},{page},{n}", $_GET['name_tamlates'] . "<><>" . $p . "<><>" . ($p + 1));                    }                    if ($pagen != 0) $backN = CMS::AdminModuleSection('42-2', "{module},{page}", $_GET['name_tamlates'] . "<><>" . ($pagen - 1));                    if (($maxPage - 1) != $pagen) $nexN = CMS::AdminModuleSection('42-3', "{module},{page}", $_GET['name_tamlates'] . "<><>" . ($pagen + 1));                    echo CMS::AdminModuleSection(41, "{list},{next},{back}", $ListPage . "<><>" . $nexN . "<><>" . $backN);                }            }        } else {            if (isset($_POST['edit'])) {                $NameNews = strip_tags($_POST['NameNews']);                $FullNews = $_POST['FCKeditor'];                $SearchText = strip_tags($FullNews);                $IdCategory = $_POST['category'];                if ($_POST['addcomment'] == 1) $commentsAdd = 1;                else $commentsAdd = 0;                if (!is_numeric($IdCategory) || $IdCategory < 1) $IdCategory = 0;                $SmallText = trim(ModuleNews::SelectTextSmall($FullNews));                if (!is_numeric($_POST['day']) || !is_numeric($_POST['month']) || !is_numeric($_POST['year']) || !is_numeric($_POST['hour']) || !is_numeric($_POST['minute']) || !is_numeric($_POST['second'])) echo CMS::AlertWindow('Ошибка', 'Не верный формат даты', 3, 0);                else {                    if (strlen($NameNews) < 3) echo CMS::AlertWindow('Ошибка', 'Название новости должно быть более 3-х символов', 3, 0);                    else {                        if (empty($FullNews)) echo CMS::AlertWindow('Ошибка', 'Не указан текст новости', 3, 0);                        else {                            if ($_POST['enddate'] && ($_POST['year'] > $_POST['yearend'] ||                                    ($_POST['month'] > $_POST['monthend'] && $_POST['year'] == $_POST['yearend']) ||                                    ($_POST['day'] > $_POST['dayend'] && $_POST['month'] == $_POST['monthend'] && $_POST['year'] == $_POST['yearend']) ||                                    ($_POST['day'] == $_POST['dayend'] && $_POST['month'] == $_POST['monthend'] && $_POST['year'] == $_POST['yearend'] &&                                        ($_POST['hour'] > $_POST['hourend'] || (($_POST['minute'] > $_POST['minuteend'] || ($_POST['second'] > $_POST['secondend'] && $_POST['minute'] == $_POST['minuteend'])) && $_POST['hour'] == $_POST['hourend'])))))                                echo CMS::AlertWindow('Ошибка', 'Дата начала публикации больше даты окончания', 3, 0);                            else {                                //echo CMS::AlertWindow('Успешно','Данные обновлены',1,0);                                $DateNews = dateFormat($_POST['year']) . '-' . (dateFormat($_POST['month']) + 1) . '-' . dateFormat($_POST['day']);                                $TimeNews = dateFormat($_POST['hour']) . ':' . dateFormat($_POST['minute']) . ':' . dateFormat($_POST['second']);                                if ($_POST['enddate']) {                                    $DateNewsEnd = dateFormat($_POST['yearend']) . '-' . (dateFormat($_POST['monthend']) + 1) . '-' . dateFormat($_POST['dayend']);                                    $TimeNewsEnd = dateFormat($_POST['hourend']) . ':' . dateFormat($_POST['minuteend']) . ':' . dateFormat($_POST['secondend']);                                }                                $clearImg = 0;                                $file = $_FILES['file']['tmp_name'];                                $file_name = $_FILES['file']['name'];                                if (!empty($file_name) || $_POST['image'] == 'on') {                                    $SelectType = Simple_DbApi::select_db($_GET['name_tamlates'], 'id,type', 'id', $_GET['id_news'], '', '', 0, 1);                                    $ni = current($SelectType);                                    if (!empty($ni['type'])) {                                        if (file_exists('images/' . $_GET['name_tamlates'] . '/small/' . $ni['id'] . '.' . $ni['type'])) unlink('images/' . $_GET['name_tamlates'] . '/small/' . $ni['id'] . '.' . $ni['type']);                                        $clearImg = 1;                                    }                                }                                if (!empty($file_name)) {                                    $nameFile = $ni['id'] . "." . simple_imagetest_format($file_name, 2);                                    $path3 = "images/" . $_GET['name_tamlates'] . "/small/" . $nameFile;                                    move_uploaded_file($file, $path3);                                    simple_image_save($SmallImageWidth, $SmallImageHeight, $path3, $path3, simple_imagetest_format($file_name, 2), 1);                                    Simple_DbApi::update_db($_GET['name_tamlates'], "id_cat,name,search,small,full,comment,date,time,dateend,timeend,type", $IdCategory . "<><>" . $NameNews . "<><>" . $SearchText . "<><>" . $SmallText . "<><>" . $FullNews . "<><>" . $commentsAdd . "<><>" . $DateNews . "<><>" . $TimeNews . "<><>" . $DateNewsEnd . "<><>" . $TimeNewsEnd . '<><>' . simple_imagetest_format($file_name, 2), "id", $_GET['id_news']);                                } else {                                    if ($clearImg == 1)                                        Simple_DbApi::update_db($_GET['name_tamlates'], "id_cat,name,search,small,full,comment,date,time,dateend,timeend,type", $IdCategory . "<><>" . $NameNews . "<><>" . $SearchText . "<><>" . $SmallText . "<><>" . $FullNews . "<><>" . $commentsAdd . "<><>" . $DateNews . "<><>" . $TimeNews . "<><>" . $DateNewsEnd . "<><>" . $TimeNewsEnd . "<><>" . '', "id", $_GET['id_news']);                                    else                                        Simple_DbApi::update_db($_GET['name_tamlates'], "id_cat,name,search,small,full,comment,date,time,dateend,timeend", $IdCategory . "<><>" . $NameNews . "<><>" . $SearchText . "<><>" . $SmallText . "<><>" . $FullNews . "<><>" . $commentsAdd . "<><>" . $DateNews . "<><>" . $TimeNews . "<><>" . $DateNewsEnd . "<><>" . $TimeNewsEnd, "id", $_GET['id_news']);                                }                                //	Simple_DbApi::update_db($_GET['name_tamlates'],"id_cat,name,search,small,full,comment,date,time,dateend,timeend",$IdCategory."<><>".$NameNews."<><>".$SearchText."<><>".$SmallText."<><>".$FullNews."<><>".$commentsAdd."<><>".$DateNews."<><>".$TimeNews."<><>".$DateNewsEnd."<><>".$TimeNewsEnd,"id",$_GET['id_news']);                                CMS::UpdateSearchText($_GET['id_news'], $SearchText, $NameNews, "/" . $_GET['name_tamlates'] . "/0/in/" . $IdCategory . "/0/" . $_GET['id_news'] . "/");                                CMS::UserEvents('<b>' . $_SESSION["login_admin"] . '</b> внес изменения в новость <b>' . $NameNews . '</b> в модуле <b>' . $TitleModule . '</b>. Раздел <a target="_blank" href="main-modules-setting-mod-' . $_GET['name_tamlates'] . '-' . $_GET['page'] . '-' . $_GET['id_cat'] . '-' . $_GET['id_news'] . '.pl"><b>Редактировать новости</b></a>');                                echo CMS::AlertWindow('Успешно', 'Данные обновлены', 1, 0);                                # DESTROY #                                unset($NameNews);                                unset($FullNews);                                unset($SearchText);                                unset($IdCategory);                                unset($commentsAdd);                            }                        }                    }                }            }            $SelectNews = Simple_DbApi::select_db($_GET['name_tamlates'], "*", "id", $_GET['id_news'], "", "", "", "");            if (!empty($SelectNews)) {                $ne = current($SelectNews);                $com1 = "";                $com2 = "";                if ($ne['comment'] == 1) $com1 = "selected";                else $com2 = "selected";                $FormComment = CMS::AdminModuleSection(22, "{com1},{com2}", $com1 . "<><>" . $com2);                $ne['full'] = htmlspecialchars($ne['full']);                $ne['full'] = html_entity_decode($ne['full']);                $ne['full'] = str_replace("\\", "", $ne['full']);                $editor = CMS::CKeditor($ne['full'], '', '');                $SelectC = Simple_DbApi::select_db($_GET['name_tamlates'] . "_cat", "*", "", "", "names", 1, "", "");                foreach ($SelectC as $i => $nc) {                    if ($ne['id_cat'] == $nc['ids']) $select = "selected";                    $list .= CMS::AdminModuleSection(19, "{ID},{NAME},{selected}", $nc['ids'] . "<><>" . $nc['names'] . "<><>" . $select);                    unset($select);                }                list($y1, $m1, $d1) = explode('-', $ne['date'], 3);                list($h1, $mm1, $s1) = explode(':', $ne['time'], 3);                list($y2, $m2, $d2) = explode('-', $ne['dateend'], 3);                list($h2, $mm2, $s2) = explode(':', $ne['timeend'], 3);                # DATE #                for ($d = 1; $d < 32; $d++) {                    if (round($d1) == $d) $day .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                    else $day .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                }                unset($d);                for ($d = 0; $d < count($DateList); $d++) {                    if ((round($m1) - 1) == $d) $month .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>selected');                    else $month .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>');                }                unset($d);                for ($d = 0; $d < 24; $d++) {                    if (round($h1) == $d) $hour .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                    else $hour .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                }                unset($d);                for ($d = 0; $d < 60; $d++) {                    if (round($mm1) == $d) $minute .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                    else $minute .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                }                for ($d = 0; $d < 60; $d++) {                    if (round($s1) == $d) $second .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                    else $second .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                }                #DATE2#                if (round($y2)) {                    for ($d = 1; $d < 32; $d++) {                        if (round($d2) == $d) $dayend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                        else $dayend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                    }                    for ($d = 0; $d < count($DateList); $d++) {                        if ((round($m2) - 1) == $d) $monthend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>selected');                        else $monthend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $DateList[$d] . '<><>');                    }                    for ($d = 0; $d < 24; $d++) {                        if (round($h2) == $d) $hourend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                        else $hourend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                    }                    for ($d = 0; $d < 60; $d++) {                        if (round($mm2) == $d) $minuteend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                        else $minuteend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                    }                    for ($d = 0; $d < 60; $d++) {                        if (round($s2) == $d) $secondend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>selected');                        else $secondend .= CMS::AdminModuleSection(65, '{n},{name},{s}', $d . '<><>' . $d . '<><>');                    }                    $checkdate2 = "checked";                    $visibledate2 = "block";                } else {                    $dayend = $day;                    $monthend = $month;                    $hourend = $hour;                    $minuteend = $minute;                    $secondend = $second;                    $y2 = $y1;                    $checkdate2 = "";                    $visibledate2 = "none";                }                //картинка                $image = '';                if (!empty($ne['type'])) {                    if (file_exists('images/' . $_GET['name_tamlates'] . '/small/' . $ne['id'] . '.' . $ne['type'])) $image = '<img src="../images/' . $_GET['name_tamlates'] . '/small/' . $ne['id'] . '.' . $ne['type'] . '" height="70" alt="" />';                }                if (!empty($image)) $img = CMS::AdminModuleSection(40, '{image}', $image);                //end картинка                echo CMS::AdminModuleSection(44, "{form},{CATEGORY},{name},{comment},{module},{page},{day},{month},{year},{hour},{minute},{second},{dayend},{monthend},{yearend},{hourend},{minuteend},{secondend},{check},{visible},{image}", $editor . "<><>" . $list . "<><>" . $ne['name'] . "<><>" . $FormComment . "<><>" . $_GET['name_tamlates'] . "<><>" . $_GET['id_cat'] . "<><>" . $day . "<><>" . $month . "<><>" . $y1 . "<><>" . $hour . "<><>" . $minute . "<><>" . $second . "<><>" . $dayend . "<><>" . $monthend . "<><>" . $y2 . "<><>" . $hourend . "<><>" . $minuteend . "<><>" . $secondend . "<><>" . $checkdate2 . "<><>" . $visibledate2 . "<><>" . $img);                ### COMENTS LIST ###                if (!isset($_POST['pageC']) || !is_numeric($_POST['pageC'])) $PageCom = 0;                else $PageCom = $_POST['pageC'];                if (isset($_POST['IdCom'])) {                    Simple_DbApi::delete_db($_GET['name_tamlates'] . "_comment", "id", $_POST['IdCom']);                    Simple_DbApi::update_db($_GET['name_tamlates'], "countcomments", Simple_DbApi::CountTable($_GET['name_tamlates'] . "_comment", "IdNews", $_GET['id_news']), "id", $_GET['id_news']);                    echo CMS::AlertWindow('Успешно', 'Комментарий удален', 1, 0);                }                $limit = abs($PageCom * $MaxNewsOnPage);                $countComm = Simple_DbApi::CountTable($_GET['name_tamlates'] . "_comment", "IdNews", $_GET['id_news']);                $SelectCommnets = Simple_DbApi::select_db($_GET['name_tamlates'] . "_comment", "*", "IdNews", $_GET['id_news'], "id", 2, $limit, $MaxNewsOnPage);                foreach ($SelectCommnets as $j => $nb) {                    $ListComs .= CMS::AdminModuleSection(58, "{name},{text},{ip},{id}", $nb['name'] . "<><>" . $nb['text'] . "<><>" . $nb['ip'] . "<><>" . $nb['id']);                }                if ($countComm > 0) {                    echo CMS::AdminModuleSection(57, "{list}", $ListComs);                    if ($countComm > $MaxNewsOnPage) {                        $FullCommPage = intval(($countComm - 1) / $MaxNewsOnPage) + 1;                        $MaxGoBack = $FullCommPage - $MaxListNumber;                        if ($PageCom > ($FullCommPage - 1) || $PageCom < 0) $pageNews = 0;                        if (($PageCom + 1) <= $MaxListNumber) {                            $start = 0;                            if ($MaxListNumber > $FullCommPage) $end = $FullCommPage;                            else $end = $MaxListNumber;                        } else {                            if ($PageCom == ($FullCommPage - 1) || $PageCom > $MaxGoBack) {                                $start = $FullCommPage - $MaxListNumber;                                $end = $FullCommPage;                            } else {                                $start = $PageCom - (round($MaxListNumber / 2));                                $end = $MaxListNumber + $start;                            }                        }                        for ($r = $start; $r < $end; $r++) {                            if ($r == $PageCom) $ListComnets .= CMS::AdminModuleSection(60, "{n}", ($r + 1));                            else $ListComnets .= CMS::AdminModuleSection(59, "{n},{n1}", ($r + 1) . "<><>" . $r);                        }                    }                    if ($PageCom != 0) $backP = CMS::AdminModuleSection('60-2', "{n}", ($PageCom - 1));                    if (($FullCommPage - 1) != $PageCom) $nextP = CMS::AdminModuleSection('60-3', "{n}", ($PageCom + 1));                    echo CMS::AdminModuleSection('60-1', "{list},{back},{next}", $ListComnets . "<><>" . $backP . "<><>" . $nextP);                    echo CMS::AdminModuleSection(61, '', '');                }                //$SelectCom = Simple_DbApi::select_db($_GET['name_tamlates']."_comment ","*","","","","","","");                ### END ###            } else echo CMS::AdminModuleSection(38, "{module}", $_GET['name_tamlates']);        }    } else CMS::AdminModuleSection(43, "{module}", $_GET['name_tamlates']);}echo CMS::AdminModuleSection(25, "", "");?>